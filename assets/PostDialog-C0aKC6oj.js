const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/CommentComponent-DalM3Ebi.js","assets/CommentComponent.vue_vue_type_script_setup_true_lang-CbNzdYNr.js","assets/index-atiAgRsb.js","assets/index-DI-gpe9-.css","assets/QSpace-DXpigZME.js","assets/QMenu-WQ8CjRJa.js","assets/QScrollArea-DkdG9qTr.js","assets/QScrollObserver-CIwuO6ti.js","assets/format-CbTbOXc7.js","assets/ReactionButtons.vue_vue_type_script_setup_true_lang-DbtKUaGe.js","assets/MyButton.vue_vue_type_script_setup_true_lang-Ce7HBHdZ.js","assets/i18n-BIp6Md8j.js","assets/UserAvatar-o4-OhIGa.js","assets/UserAvatar.vue_vue_type_script_setup_true_lang-DdmgEZ4s.js","assets/profile-store-C6AA8iX5.js"])))=>i.map(i=>d[i]);
import{j as ie,E as n,V as re,h as ue,W as U,F as de,X as me,k as P,o as c,w as _,l as a,s as h,m as i,H as O,q as V,p as R,n as W,t as j,R as ce,Y as ve,Z as pe,Q as fe,_ as F,$ as z,a0 as _e,a1 as he}from"./index-atiAgRsb.js";import{Q as X}from"./QSpace-DXpigZME.js";import{Q as ge}from"./QScrollArea-DkdG9qTr.js";import{_ as ye}from"./PostComponent.vue_vue_type_script_setup_true_lang-C6RUTyih.js";import{_ as be}from"./CloseableContent.vue_vue_type_script_setup_true_lang-C4DN17WY.js";import{_ as Ce}from"./MyVirtualScroll.vue_vue_type_script_setup_true_lang-C4Ypu4hN.js";import{u as Y}from"./use-dialog-plugin-component-CxAAD07u.js";import{u as ke}from"./profile-store-C6AA8iX5.js";import{a as we,_ as x}from"./MyButton.vue_vue_type_script_setup_true_lang-Ce7HBHdZ.js";import{_ as $e}from"./MySelect.vue_vue_type_script_setup_true_lang-DrdnXnM-.js";import{_ as De}from"./RectSkeleton.vue_vue_type_script_setup_true_lang-Nw230hgU.js";import"./QScrollObserver-CIwuO6ti.js";import"./QMenu-WQ8CjRJa.js";import"./format-CbTbOXc7.js";import"./i18n-BIp6Md8j.js";import"./ReactionButtons.vue_vue_type_script_setup_true_lang-DbtKUaGe.js";import"./MyChip.vue_vue_type_script_setup_true_lang-Cd1fbu6_.js";import"./CategoryButtons.vue_vue_type_script_setup_true_lang-u902ggbm.js";import"./ClosePopup-JVZGKZRE.js";const Ve={class:"dialog-header",style:{"z-index":"2"}},xe={class:"horizontal-container label-container"},Se={class:"dialog-content-inner"},Le={class:"card dialog-section q-mb-sm",style:{"z-index":"2"}},Pe={class:"horizontal-container"},Re={key:0,class:"no-comments"},ze={key:1,class:"load-more-container"},Ae={key:1,class:"card send-comment"},Ee={class:"card-section"},Qe={class:"horizontal-container align-end full-width"},tt=ie({__name:"PostDialog",props:{post:{},firstComment:{},autoLoad:{type:Boolean,default:!0}},emits:[...Y.emits],setup(Z){var M,N,T;const G=j(()=>F(()=>import("./CommentComponent-DalM3Ebi.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11]))),J=j(()=>F(()=>import("./UserAvatar-o4-OhIGa.js"),__vite__mapDeps([12,13,2,3,14]))),v=Z,p=n(!1),A=ke(),r=re(v.post),E=n(Date.now()),l=n([]),u=n([]),S=n(!0),Q=n(null),g=n(null),y=n(v.autoLoad),d=n((N=(M=v.firstComment)==null?void 0:M.type)!=null?N:"comment"),q=ue(()=>{var e;return d.value=="comment"||d.value=="update"&&r.value.user_id==((e=A.profile)==null?void 0:e.user_id)}),ee=[{key:"comment",labelKey:"comments",icon:"chat_bubble"},{key:"update",labelKey:"updates",icon:"update"}];U(d,()=>{I()});let K=!0,L,b=new AbortController;const m=n(((T=r.value._meta)==null?void 0:T.text)||""),C=n(!1);U(m,()=>ae("text",m.value));const{dialogRef:k,onDialogHide:te}=Y();function H(){y.value=!0,z(()=>{var e;(e=g.value)==null||e.checkLoading()})}function oe(e){S.value=e.position.top<Q.value.scrollHeight+66||e.direction=="up"}function I(){b.abort(),b=new AbortController,p.value=!1,l.value=[],u.value=[],E.value=Date.now(),L=void 0,S.value=!0,y.value||H()}function ae(e,t){var o;(o=r.value)._meta||(o._meta={}),r.value._meta[e]=t}async function se(e,t){var w;p.value=!1;const o=[];(w=u.value)!=null||(u.value=[]);try{if(u.value.length===0){const s=await _e(r.value.post_id,L,d.value,{signal:b.signal}),f=s.data.data.comments;if(K=s.data.data.has_more,L=s.data.data.next_cursor,s.data.success){const $=s.data.data.users;u.value.push(...f.map(D=>({...D,user:$[D.user_id]})))}}if(o.push(...u.value.splice(0,5)),o.length>0){const s=l.value;o.forEach(f=>{const $=s.findIndex(D=>D.comment_id===f.comment_id);$!==-1?s[$]=f:s.push(f)}),l.value=s}t(!(K||u.value.length>0))}catch(s){throw t(!0),s}finally{l.value.length==0&&(p.value=!0)}}async function B(e){if(!(e instanceof KeyboardEvent&&e.shiftKey)){C.value=!0;try{const t=await he(r.value.post_id,m.value,d.value);if(t.data.success){const o={...t.data.data,user:await A.getProfile()};l.value.unshift(o),m.value="",r.value.comments_count+=1}}finally{p.value=!1,C.value=!1,z(()=>{var t;return(t=g.value)==null?void 0:t.updateShowedItems(1)})}}}function le(){var e;(e=k.value)==null||e.hide()}function ne(e){l.value=l.value.filter(t=>t.comment_id!==e),r.value.comments_count-=1,z(()=>{var t;return(t=g.value)==null?void 0:t.updateShowedItems()})}return de(()=>{v.firstComment&&l.value.push(v.firstComment)}),me(()=>{l.value=[],u.value=[],b.abort()}),(e,t)=>(c(),P(fe,{"transition-show":"slide-up","transition-hide":"slide-down",class:"post-dialog card-dialog",ref_key:"dialogRef",ref:k,onHide:h(te),maximized:"",key:e.post.post_id},{default:_(()=>[a(be,{onHide:t[3]||(t[3]=o=>h(k).hide())},{default:_(()=>[i("div",Ve,[i("div",xe,[a(we,{icon:"article",class:"header-icon"}),i("div",null,O(e.$t("post")),1),a(X),a(x,{icon:"close",onClick:t[0]||(t[0]=o=>h(k).hide())})])]),i("div",Se,[a(ge,{class:"scroll-area fix-scroll-area",visible:!1},{default:_(()=>[i("div",{ref_key:"postComponentRef",ref:Q},[a(ye,{post:r.value,"in-dialog":!0,onDeletePost:le,style:{"z-index":"2"}},null,8,["post"])],512),i("div",{class:W(["sticky-label scroll-header q-pt-sm",{"is-visible":S.value}])},[i("div",Le,[i("div",Pe,[a($e,{options:ee,modelValue:d.value,"onUpdate:modelValue":t[1]||(t[1]=o=>d.value=o)},null,8,["modelValue"]),a(X),a(x,{icon:"refresh",onClick:I})])])],2),p.value?(c(),R("div",Re,O(d.value=="comment"?e.$t("no_comments"):e.$t("no_updates")),1)):V("",!0),(c(),P(Ce,{items:l.value,margins:8,"item-key":"comment_id",onLoadMore:se,onScroll:oe,"infinite-load-type":y.value?"bottom":"none",key:E.value,class:"posts-infinite-scroll",ref_key:"virtualScroll",ref:g,"skeleton-height":126},{default:_(({item:o,index:w})=>[a(h(G),{comment:o,class:W({"q-mb-sm":w+1<l.value.length}),onDeleteComment:ne,"in-dialog":!0},null,8,["comment","class"])]),skeleton:_(()=>[a(De,{height:"126px",class:"card q-mb-sm"})]),_:1},8,["items","infinite-load-type"])),y.value?V("",!0):(c(),R("div",ze,[a(x,{class:"load-more",type:"primary",onClick:H,"icon-right":"arrow_circle_down",label:e.$t("load_more")},null,8,["label"])]))]),_:1}),q.value?(c(),P(ce,{key:0,class:"q-mb-sm q-mt-sm"})):V("",!0),q.value?(c(),R("div",Ae,[i("div",Ee,[i("div",Qe,[a(h(J),{me:!0}),a(ve,{dense:"",borderless:"",rounded:"",modelValue:m.value,"onUpdate:modelValue":t[2]||(t[2]=o=>m.value=o),autogrow:"",maxlength:"1024",label:d.value=="comment"?e.$t("enter_comment"):e.$t("add_update"),class:"full-width enter-comment",disable:C.value,onKeydown:pe(B,["enter"])},null,8,["modelValue","label","disable"]),a(x,{icon:"send",class:"send-button",onClick:B,loading:C.value,disable:m.value.length==0},null,8,["loading","disable"])])])])):V("",!0)])]),_:1})]),_:1},8,["onHide"]))}});export{tt as default};
