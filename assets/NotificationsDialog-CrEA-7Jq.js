import{Q as b}from"./QSpace-BTOj6ZwW.js";import{Q as B}from"./QScrollArea-DRPlhDGS.js";import{j as H,u as M,E as r,W as q,$ as E,F as A,ae as k,X as U,M as V,k as $,o as u,w as c,l as i,s as l,m as s,H as d,p as R,q as j,af as F,n as I,Q as K,ag as L}from"./index-Ck4zLN3I.js";import{u as w}from"./use-dialog-plugin-component-C--L0L25.js";import{_ as P}from"./MyVirtualScroll.vue_vue_type_script_setup_true_lang-B5QiE7EM.js";import{a as y,_ as C}from"./MyButton.vue_vue_type_script_setup_true_lang-nTcsNPgd.js";import{_ as T}from"./RectSkeleton.vue_vue_type_script_setup_true_lang-MIOZg4_m.js";import{t as N}from"./format-DFL9WMHh.js";import{_ as W}from"./CloseableContent.vue_vue_type_script_setup_true_lang-D37Qmmai.js";import{_ as X}from"./NotificationCard.vue_vue_type_script_setup_true_lang-siNynd3G.js";import"./QScrollObserver-IHi_X4zs.js";const G={class:"dialog-header horizontal-container"},J={class:"horizontal-container label-container"},O={class:"label"},Y={class:"dialog-content-inner"},Z={key:0,class:"no-notifications"},oo={class:"unread-notifications card horizontal-container q-mb-sm"},ao={class:"label"},to={class:"count"},po=H({__name:"NotificationsDialog",emits:[...w.emits],setup(eo){const{dialogRef:f,onDialogHide:S}=w(),m=M(),D=r(!1),_=r(null),Q=r(Date.now()),n=r([]),x=r({});let h;const p=new AbortController;q(m.lastNotifications,e=>{e.forEach(a=>{n.value.some(o=>a.id===o.id)||(n.value.unshift(a),E(()=>{var o;return(o=_.value)==null?void 0:o.updateShowedItems()}))})},{deep:!1,immediate:!1});async function z(e,a){try{const o=await L(h,25,{signal:p.signal});o.data.success?(h=o.data.data.next_cursor,o.data.data.notifications.forEach(t=>{var v;t.message&&(t.message=N(t.message,256)),(v=t.loaded)!=null&&v.content&&(t.loaded.content=N(t.loaded.content,256))}),n.value.push(...o.data.data.notifications),a(!o.data.data.has_more)):a(!0)}catch(o){throw a(!0),o}}function g(e){if("id"in e){const a=e.id,o=n.value.find(t=>t.id==a);o&&o.unread&&(o.unread=!1)}else for(const a of n.value)a.unread=!1}return A(()=>{k.on("notification_read",g)}),U(()=>{p.abort()}),V(()=>{k.off("notification_read",g)}),(e,a)=>(u(),$(K,{"transition-show":"slide-up","transition-hide":"slide-down",class:"notifications-dialog card-dialog",ref_key:"dialogRef",ref:f,onHide:l(S),maximized:""},{default:c(()=>[i(W,{onHide:a[2]||(a[2]=o=>l(f).hide())},{default:c(()=>[s("div",G,[s("div",J,[i(y,{icon:"notifications",class:"header-icon"}),s("div",O,d(e.$t("notifications.label")),1)]),i(b),i(C,{icon:"close",onClick:a[0]||(a[0]=o=>{var t;return(t=l(f))==null?void 0:t.hide()})})]),s("div",Y,[i(B,{class:"scroll-area fix-scroll-area full-height",visible:!1},{default:c(()=>[D.value?(u(),R("div",Z,d(e.$t("no_notifications")),1)):j("",!0),s("div",oo,[s("span",null,[i(y,{icon:"visibility"}),s("span",ao,d(e.$t("unread"))+": ",1),s("span",to,d(l(m).getUnreadCount()),1)]),i(b),i(C,{label:e.$t("read_all"),type:"outlined",onClick:a[1]||(a[1]=()=>void l(F)()),disable:l(m).unreadCount==0},null,8,["label","disable"])]),(u(),$(P,{items:n.value,margins:8,"item-key":"id",onLoadMore:z,"infinite-load-type":"bottom",key:Q.value,class:"posts-infinite-scroll",ref_key:"virtualScroll",ref:_,"min-item-height":60,"skeleton-height":60},{default:c(({item:o,index:t})=>[i(X,{notif:o,cache:x.value,class:I({"q-mb-sm":t+1<n.value.length})},null,8,["notif","cache","class"])]),skeleton:c(()=>[i(T,{height:"60px",class:"card q-mb-sm"})]),_:1},8,["items"]))]),_:1})])]),_:1})]),_:1},8,["onHide"]))}});export{po as default};
