import{Q as v}from"./QSpace-BLX8xWL2.js";import{Q as z}from"./QScrollArea-BfWxh7rm.js";import{j as H,u as M,E as c,W as B,$ as q,F as A,ae as b,X as E,M as U,k,o as y,w as r,l as t,s as l,m as s,H as m,af as R,n as V,Q as j,ag as F}from"./index-CW-_h3H6.js";import{u as $}from"./use-dialog-plugin-component-C0eY4yAd.js";import{_ as I}from"./MyVirtualScroll.vue_vue_type_script_setup_true_lang--lf3OY7K.js";import{a as w,_ as C}from"./MyButton.vue_vue_type_script_setup_true_lang-aOd0h3La.js";import{_ as K}from"./RectSkeleton.vue_vue_type_script_setup_true_lang-DcvU8W5z.js";import{t as S}from"./format-CjHWdibf.js";import{_ as L}from"./CloseableContent.vue_vue_type_script_setup_true_lang-CSTaD23l.js";import{_ as P}from"./NotificationCard.vue_vue_type_script_setup_true_lang-BOYUb8X3.js";import"./QScrollObserver-B0ZGY-Hj.js";const T={class:"dialog-header horizontal-container"},W={class:"horizontal-container label-container"},X={class:"label"},G={class:"dialog-content-inner"},J={class:"unread-notifications card horizontal-container q-mb-sm"},O={class:"label"},Y={class:"count"},fa=H({__name:"NotificationsDialog",emits:[...$.emits],setup(Z){const{dialogRef:d,onDialogHide:x}=$(),f=M(),u=c(null),D=c(Date.now()),n=c([]),N=c({});let _;const h=new AbortController;B(f.lastNotifications,e=>{e.forEach(o=>{n.value.some(a=>o.id===a.id)||(n.value.unshift(o),q(()=>{var a;return(a=u.value)==null?void 0:a.updateShowedItems()}))})},{deep:!1,immediate:!1});async function Q(e,o){try{const a=await F(_,25,{signal:h.signal});a.data.success?(_=a.data.data.next_cursor,a.data.data.notifications.forEach(i=>{var g;i.message&&(i.message=S(i.message,256)),(g=i.loaded)!=null&&g.content&&(i.loaded.content=S(i.loaded.content,256))}),n.value.push(...a.data.data.notifications),o(!a.data.data.has_more)):o(!0)}catch(a){throw o(!0),a}}function p(e){if("id"in e){const o=e.id,a=n.value.find(i=>i.id==o);a&&a.unread&&(a.unread=!1)}else for(const o of n.value)o.unread=!1}return A(()=>{b.on("notification_read",p)}),E(()=>{h.abort()}),U(()=>{b.off("notification_read",p)}),(e,o)=>(y(),k(j,{"transition-show":"slide-up","transition-hide":"slide-down",class:"notifications-dialog card-dialog",ref_key:"dialogRef",ref:d,onHide:l(x),maximized:""},{default:r(()=>[t(L,{onHide:o[2]||(o[2]=a=>l(d).hide())},{default:r(()=>[s("div",T,[s("div",W,[t(w,{icon:"notifications",class:"header-icon"}),s("div",X,m(e.$t("notifications.label")),1)]),t(v),t(C,{icon:"close",onClick:o[0]||(o[0]=a=>{var i;return(i=l(d))==null?void 0:i.hide()})})]),s("div",G,[t(z,{class:"scroll-area fix-scroll-area full-height",visible:!1},{default:r(()=>[s("div",J,[s("span",null,[t(w,{icon:"visibility"}),s("span",O,m(e.$t("unread"))+": ",1),s("span",Y,m(l(f).getUnreadCount()),1)]),t(v),t(C,{icon:"mark_chat_read",label:e.$t("read_all"),type:"outlined",onClick:o[1]||(o[1]=()=>void l(R)()),disable:l(f).unreadCount==0},null,8,["label","disable"])]),(y(),k(I,{items:n.value,margins:8,"item-key":"id",onLoadMore:Q,"infinite-load-type":"bottom",key:D.value,class:"posts-infinite-scroll",ref_key:"virtualScroll",ref:u,"min-item-height":60,"skeleton-height":60,"no-items-key":"notifications.no_notifications"},{default:r(({item:a,index:i})=>[t(P,{notif:a,cache:N.value,class:V({"q-mb-sm":i+1<n.value.length})},null,8,["notif","cache","class"])]),skeleton:r(()=>[t(K,{height:"60px",class:"card q-mb-sm"})]),_:1},8,["items"]))]),_:1})])]),_:1})]),_:1},8,["onHide"]))}});export{fa as default};
