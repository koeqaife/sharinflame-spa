import{Q as _e}from"./QSpace-BTOj6ZwW.js";import{j as he,a2 as ye,u as be,D as $e,E as n,h as ke,a3 as Ce,F as we,k as D,o as i,w as y,l,s as M,m as s,H as m,p as _,q as K,Y as L,G as U,I as F,Z as Pe,n as I,a4 as R,R as X,Q as Ve,a5 as Te,a6 as Se,a7 as Qe,a8 as ze}from"./index-Ck4zLN3I.js";import{Q as De}from"./QMenu-BpdSGsQl.js";import{Q as Ie}from"./QScrollArea-DRPlhDGS.js";import{u as Y}from"./use-dialog-plugin-component-C--L0L25.js";import{u as Me}from"./profile-store-CgHq3JBC.js";import{_ as Z}from"./ToggleCard.vue_vue_type_script_setup_true_lang-CCBHQzyq.js";import{a as x,_ as b}from"./MyButton.vue_vue_type_script_setup_true_lang-nTcsNPgd.js";import{_ as B}from"./MyChip.vue_vue_type_script_setup_true_lang-CJB2OzAT.js";import{_ as Ue}from"./CloseableContent.vue_vue_type_script_setup_true_lang-D37Qmmai.js";import"./QScrollObserver-IHi_X4zs.js";import"./MySwitch.vue_vue_type_script_setup_true_lang-Dwr58bEp.js";const Fe={class:"dialog-header horizontal-container"},Re={class:"horizontal-container label-container"},xe={class:"label"},Be={class:"dialog-content-inner"},He={class:"tags-container card"},qe={class:"horizontal-container"},Ae={class:"label"},Ee={key:0,class:"chips"},Ne={key:1},Oe={class:"hint"},je={class:"chips"},Ge={key:0,class:"card file-container"},Ke={class:"horizontal-container"},Le={class:"label"},Xe={class:"files-list container"},Ye={class:"type-container horizontal-container"},Ze={class:"drag-title"},Je={class:"file-name"},We={class:"file-size"},et={class:"send-container"},J=4,vt=he({__name:"PostEditor",props:{originalPost:{},withCtags:{}},emits:[...Y.emits],setup(W){var j;const r=W,{dialogRef:$,onDialogHide:ee}=Y(),k=ye(),te=Me(),ae=be(),{t:f}=$e(),h=n(""),g=n(""),P=n(!1),V=n(!1),d=n((j=r.withCtags)!=null?j:[]),T=n([]),p=n(!1),v=n(!1),u=n([]),S=n(!1),H=n(),C=n("post_image"),Q=ke(()=>Ce[C.value]);function oe(e){let t="b";return e>1024&&(t="kb",e/=1024),e>1024&&(t="mb",e/=1024),e>1024&&(t="gb",e/=1024),`${Math.round(e)} ${f(`file_size.${t}`)}`}function q(e){C.value=e,u.value.length=0}function le(e){u.value.splice(e,1)}function se(){H.value.click()}function ne(e){return e.size>Q.value.maxSize*1024*1024?"file_error.too_big":Q.value.allowedTypes.includes(e.type)?null:"file_error.not_allowed_type"}function A(e){if(e)for(const t of e){const a=ne(t);u.value.push({name:t.name,size:t.size,blob:t,error:a})}}function ie(e){e.target&&(A(e.target.files),e.target.value="")}function re(e){S.value=!1,e.dataTransfer&&A(e.dataTransfer.files)}function E(){const e=[...T.value];return P.value&&!e.includes("is-nsfw")&&e.push("is-nsfw"),V.value&&!e.includes("ai-generated")&&e.push("ai-generated"),e.length>0?e:void 0}function de(){v.value?ce():ve()}function ue(e,t){return!e||!t||e.length!==t.length?!1:e.slice().sort().every((a,o)=>a===t.slice().sort()[o])}async function ce(){var o,c;if(!r.originalPost)return;p.value=!0;const e=(o=E())!=null?o:[],t=h.value,a={...!ue(e,r.originalPost.tags)&&{tags:e},...t!=r.originalPost.content&&{content:t}};try{if(Object.keys(a).length===0){k.notify({type:"error-notification",message:f("post_edited.not_changed"),progress:!0});return}await Te(r.originalPost.post_id,a);const w=n(r.originalPost);w.value.content=t,w.value.tags=e,k.notify({type:"default-notification",message:f("post_edited.msg"),caption:f("post_edited.caption"),progress:!0,icon:"sym_r_done_outline"}),(c=$.value)==null||c.hide()}catch{k.notify({type:"error-notification",message:f("post_edited.failed"),progress:!0})}finally{p.value=!1}}function fe(e){let t="";for(;e>=0;)t=String.fromCharCode(97+e%26)+t,e=Math.floor(e/26)-1;return t}async function ve(){var a;p.value=!0;const e=E();let t;try{if(u.value.length>0){t=(await Se(C.value)).data.data.context_id;let w=0;const G=[];for(const z of u.value){if(z.error)continue;const ge=fe(w),pe=async()=>{try{await Qe(`${ge}-${z.name}`,z.blob,"context",void 0,t)}catch(me){throw z.error="file_error.failed_to_upload",me}};G.push(pe()),w++}await Promise.all(G)}const o=await ze({content:h.value,...t&&{file_context_id:t},tags:e,ctags:d.value});if(p.value=!1,o.data.success&&o.data.data){const c={...o.data.data,user:await te.getProfile()};ae.openDialog("post",c.post_id,{post:c}),k.notify({type:"default-notification",message:f("post_created.msg"),caption:f("post_created.caption"),progress:!0,icon:"sym_r_done_outline"}),(a=$.value)==null||a.hide()}}catch{k.notify({type:"error-notification",message:f("post_created.failed"),progress:!0})}finally{p.value=!1}}const N=()=>{g.value&&!d.value.includes(g.value)&&(d.value.push(g.value),g.value="")},O=e=>{d.value.splice(e,1)};return we(()=>{if(r.originalPost){v.value=!0,T.value=[...r.originalPost.tags],d.value=[...r.originalPost.ctags];const e=(t,a)=>{const o=T.value.indexOf(t);o!==-1&&(a.value=!0,T.value.splice(o,1))};e("is-nsfw",P),e("ai-generated",V),h.value=r.originalPost.content}}),(e,t)=>(i(),D(Ve,{"transition-show":"slide-up","transition-hide":"slide-down",class:"post-editor-dialog card-dialog",ref_key:"dialogRef",ref:$,onHide:M(ee),maximized:""},{default:y(()=>[l(Ue,{onHide:t[9]||(t[9]=a=>M($).hide())},{default:y(()=>[s("div",Fe,[s("div",Re,[l(x,{icon:v.value?"edit":"article",class:"header-icon"},null,8,["icon"]),s("div",xe,m(v.value?e.$t("edit_post"):e.$t("create_post")),1)]),l(_e),l(b,{icon:"close",onClick:t[0]||(t[0]=a=>{var o;return(o=M($))==null?void 0:o.hide()})})]),s("div",Be,[l(Ie,{class:"scroll-area fix-scroll-area",visible:!1},{default:y(()=>[l(L,{borderless:"",modelValue:h.value,"onUpdate:modelValue":t[1]||(t[1]=a=>h.value=a),autogrow:"",maxlength:"16384",label:e.$t("add_your_text_here"),class:"full-width post-text card",disable:p.value},null,8,["modelValue","label","disable"]),s("div",He,[s("div",qe,[l(x,{icon:"tag",class:"icon"}),s("div",Ae,m(e.$t("tags")),1)]),v.value?(i(),_("div",Ne,[s("div",Oe,m(e.$t("cant_change_tags_edit")),1),s("div",je,[(i(!0),_(U,null,F(d.value,(a,o)=>(i(),D(B,{key:o,icon:"tag",label:a,class:"tag"},null,8,["label"]))),128))])])):(i(),_("div",Ee,[(i(!0),_(U,null,F(d.value,(a,o)=>(i(),D(B,{key:o,removable:!0,onRemove:c=>O(o),onClick:c=>O(o),label:a,class:"tag",icon:"tag"},null,8,["onRemove","onClick","label"]))),128)),l(B,{clickable:!0,icon:"add",class:"tag",disable:d.value.length>=J,label:e.$t("add_tag")},{default:y(()=>[d.value.length<J?(i(),D(De,{key:0,class:"menu-card enter-tag-menu field-menu"},{default:y(()=>[l(L,{modelValue:g.value,"onUpdate:modelValue":t[2]||(t[2]=a=>g.value=a),label:e.$t("enter_tag"),onKeyup:Pe(N,["enter"]),borderless:"",class:"tag-input full-width",maxlength:"22"},{append:y(()=>[l(b,{icon:"add",class:"add-button",onClick:N,disable:g.value.length==0},null,8,["disable"])]),_:1},8,["modelValue","label"])]),_:1})):K("",!0)]),_:1},8,["disable","label"])]))]),v.value?K("",!0):(i(),_("div",Ge,[s("div",Ke,[l(x,{icon:"files",class:"icon"}),s("div",Le,m(e.$t("files")),1)]),s("div",Xe,[s("div",Ye,[l(b,{label:e.$t("image"),"is-category":!0,type:"card",icon:"image",class:I({selected:C.value=="post_image"}),onClick:t[3]||(t[3]=a=>q("post_image"))},null,8,["label","class"]),l(b,{label:e.$t("video"),"is-category":!0,type:"card",icon:"video_file",class:I({selected:C.value=="post_video"}),onClick:t[4]||(t[4]=a=>q("post_video"))},null,8,["label","class"])]),s("div",{class:I(["drop-area card",{"drag-over":S.value,disabled:u.value.length>=Q.value.maxCount}]),onDragover:t[5]||(t[5]=R(a=>S.value=!0,["prevent"])),onDragleave:t[6]||(t[6]=R(a=>S.value=!1,["prevent"])),onDrop:R(re,["prevent"]),onClick:se},[s("div",Ze,m(e.$t("drag_drop_title")),1),s("input",{type:"file",ref_key:"fileInput",ref:H,onChange:ie,multiple:"",hidden:""},null,544)],34),(i(!0),_(U,null,F(u.value,(a,o)=>(i(),_("div",{class:I(["card file horizontal-container",{"is-error":!!a.error}]),key:o},[s("div",Je,m(a.error&&e.$t("file_error.error",{error:e.$t(a.error)})||a.name),1),s("div",We,"("+m(oe(a.size))+")",1),l(b,{icon:"close",onClick:c=>le(o),disable:u.value.length>=Q.value.maxCount},null,8,["onClick","disable"])],2))),128))])])),l(X,{class:"separator"}),l(Z,{"label-key":"tag.nsfw",icon:"explicit",modelValue:P.value,"onUpdate:modelValue":t[7]||(t[7]=a=>P.value=a)},null,8,["modelValue"]),l(Z,{"label-key":"tag.ai",icon:"robot_2",modelValue:V.value,"onUpdate:modelValue":t[8]||(t[8]=a=>V.value=a)},null,8,["modelValue"])]),_:1}),l(X,{class:"separator q-my-sm"}),s("div",et,[l(b,{type:"primary","icon-right":v.value?"edit":"add",label:v.value?e.$t("apply"):e.$t("create"),onClick:de,disable:h.value.trim().length==0||u.value.some(a=>!!a.error),loading:p.value},null,8,["icon-right","label","disable","loading"])])])]),_:1})]),_:1},8,["onHide"]))}});export{vt as default};
