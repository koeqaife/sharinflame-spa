import{Q as pe}from"./QSpace-BZ_YrFTW.js";import{j as me,a2 as _e,u as he,D as ye,E as n,h as be,a3 as $e,F as ke,k as z,o as i,w as y,l as s,s as I,m as l,H as m,p as _,q as G,Y as K,G as M,I as R,Z as Ce,n as D,a4 as F,R as L,Q as we,a5 as Pe,a6 as Te,a7 as Ve,a8 as Se}from"./index-C4T2bIgH.js";import{Q as Qe}from"./QMenu-yq6Y8Uxc.js";import{Q as ze}from"./QScrollArea-B4qUASNi.js";import{u as X}from"./use-dialog-plugin-component-TMqOqiuh.js";import{u as De}from"./profile-store-DHKuebLZ.js";import{_ as Ie}from"./ToggleCard.vue_vue_type_script_setup_true_lang-B1Cs_4pq.js";import{a as U,_ as b}from"./MyButton.vue_vue_type_script_setup_true_lang-CYCpU-k_.js";import{_ as B}from"./MyChip.vue_vue_type_script_setup_true_lang-TNJEhOIf.js";import{_ as Me}from"./CloseableContent.vue_vue_type_script_setup_true_lang-CuiGzT6X.js";import"./QScrollObserver-CCXLn-AB.js";import"./MySwitch.vue_vue_type_script_setup_true_lang-BgaifdSg.js";const Re={class:"dialog-header horizontal-container"},Fe={class:"horizontal-container label-container"},Ue={class:"label"},Be={class:"dialog-content-inner"},xe={class:"tags-container card"},Ae={class:"horizontal-container"},He={class:"label"},qe={key:0,class:"chips"},Ee={key:1},Ne={class:"hint"},Oe={class:"chips"},je={key:0,class:"card file-container"},Ge={class:"horizontal-container"},Ke={class:"label"},Le={class:"files-list container"},Xe={class:"type-container horizontal-container"},Ye={class:"drag-title"},Ze={class:"file-name"},Je={class:"file-size"},We={class:"send-container"},Y=4,ft=me({__name:"PostEditor",props:{originalPost:{},withCtags:{}},emits:[...X.emits],setup(Z){var O;const r=Z,{dialogRef:$,onDialogHide:J}=X(),k=_e(),W=De(),ee=he(),{t:f}=ye(),h=n(""),g=n(""),P=n(!1),d=n((O=r.withCtags)!=null?O:[]),T=n([]),p=n(!1),v=n(!1),u=n([]),V=n(!1),x=n(),C=n("post_image"),S=be(()=>$e[C.value]);function te(e){let t="b";return e>1024&&(t="kb",e/=1024),e>1024&&(t="mb",e/=1024),e>1024&&(t="gb",e/=1024),`${Math.round(e)} ${f(`file_size.${t}`)}`}function A(e){C.value=e,u.value.length=0}function ae(e){u.value.splice(e,1)}function oe(){x.value.click()}function le(e){return e.size>S.value.maxSize*1024*1024?"file_error.too_big":S.value.allowedTypes.includes(e.type)?null:"file_error.not_allowed_type"}function H(e){if(e)for(const t of e){const a=le(t);u.value.push({name:t.name,size:t.size,blob:t,error:a})}}function se(e){e.target&&(H(e.target.files),e.target.value="")}function ne(e){V.value=!1,e.dataTransfer&&H(e.dataTransfer.files)}function q(){const e=[...T.value];return P.value&&!e.includes("ai-generated")&&e.push("ai-generated"),e.length>0?e:void 0}function ie(){v.value?de():ce()}function re(e,t){return!e||!t||e.length!==t.length?!1:e.slice().sort().every((a,o)=>a===t.slice().sort()[o])}async function de(){var o,c;if(!r.originalPost)return;p.value=!0;const e=(o=q())!=null?o:[],t=h.value,a={...!re(e,r.originalPost.tags)&&{tags:e},...t!=r.originalPost.content&&{content:t}};try{if(Object.keys(a).length===0){k.notify({type:"error-notification",message:f("post_edited.not_changed"),progress:!0});return}await Pe(r.originalPost.post_id,a);const w=n(r.originalPost);w.value.content=t,w.value.tags=e,k.notify({type:"default-notification",message:f("post_edited.msg"),caption:f("post_edited.caption"),progress:!0,icon:"sym_r_done_outline"}),(c=$.value)==null||c.hide()}catch{k.notify({type:"error-notification",message:f("post_edited.failed"),progress:!0})}finally{p.value=!1}}function ue(e){let t="";for(;e>=0;)t=String.fromCharCode(97+e%26)+t,e=Math.floor(e/26)-1;return t}async function ce(){var a;p.value=!0;const e=q();let t;try{if(u.value.length>0){t=(await Te(C.value)).data.data.context_id;let w=0;const j=[];for(const Q of u.value){if(Q.error)continue;const fe=ue(w),ve=async()=>{try{await Ve(`${fe}-${Q.name}`,Q.blob,"context",void 0,t)}catch(ge){throw Q.error="file_error.failed_to_upload",ge}};j.push(ve()),w++}await Promise.all(j)}const o=await Se({content:h.value,...t&&{file_context_id:t},tags:e,ctags:d.value});if(p.value=!1,o.data.success&&o.data.data){const c={...o.data.data,user:await W.getProfile()};ee.openDialog("post",c.post_id,{post:c}),k.notify({type:"default-notification",message:f("post_created.msg"),caption:f("post_created.caption"),progress:!0,icon:"sym_r_done_outline"}),(a=$.value)==null||a.hide()}}catch{k.notify({type:"error-notification",message:f("post_created.failed"),progress:!0})}finally{p.value=!1}}const E=()=>{g.value&&!d.value.includes(g.value)&&(d.value.push(g.value),g.value="")},N=e=>{d.value.splice(e,1)};return ke(()=>{r.originalPost&&(v.value=!0,T.value=[...r.originalPost.tags],d.value=[...r.originalPost.ctags],((t,a)=>{const o=T.value.indexOf(t);o!==-1&&(a.value=!0,T.value.splice(o,1))})("ai-generated",P),h.value=r.originalPost.content)}),(e,t)=>(i(),z(we,{"transition-show":"slide-up","transition-hide":"slide-down",class:"post-editor-dialog card-dialog",ref_key:"dialogRef",ref:$,onHide:I(J),maximized:""},{default:y(()=>[s(Me,{onHide:t[8]||(t[8]=a=>I($).hide())},{default:y(()=>[l("div",Re,[l("div",Fe,[s(U,{icon:v.value?"edit":"article",class:"header-icon"},null,8,["icon"]),l("div",Ue,m(v.value?e.$t("edit_post"):e.$t("create_post")),1)]),s(pe),s(b,{icon:"close",onClick:t[0]||(t[0]=a=>{var o;return(o=I($))==null?void 0:o.hide()})})]),l("div",Be,[s(ze,{class:"scroll-area fix-scroll-area",visible:!1},{default:y(()=>[s(K,{borderless:"",modelValue:h.value,"onUpdate:modelValue":t[1]||(t[1]=a=>h.value=a),autogrow:"",maxlength:"16384",label:e.$t("add_your_text_here"),class:"full-width post-text card",disable:p.value},null,8,["modelValue","label","disable"]),l("div",xe,[l("div",Ae,[s(U,{icon:"tag",class:"icon"}),l("div",He,m(e.$t("tags")),1)]),v.value?(i(),_("div",Ee,[l("div",Ne,m(e.$t("cant_change_tags_edit")),1),l("div",Oe,[(i(!0),_(M,null,R(d.value,(a,o)=>(i(),z(B,{key:o,icon:"tag",label:a,class:"tag"},null,8,["label"]))),128))])])):(i(),_("div",qe,[(i(!0),_(M,null,R(d.value,(a,o)=>(i(),z(B,{key:o,removable:!0,onRemove:c=>N(o),onClick:c=>N(o),label:a,class:"tag",icon:"tag"},null,8,["onRemove","onClick","label"]))),128)),s(B,{clickable:!0,icon:"add",class:"tag",disable:d.value.length>=Y,label:e.$t("add_tag")},{default:y(()=>[d.value.length<Y?(i(),z(Qe,{key:0,class:"menu-card enter-tag-menu field-menu"},{default:y(()=>[s(K,{modelValue:g.value,"onUpdate:modelValue":t[2]||(t[2]=a=>g.value=a),label:e.$t("enter_tag"),onKeyup:Ce(E,["enter"]),borderless:"",class:"tag-input full-width",maxlength:"22"},{append:y(()=>[s(b,{icon:"add",class:"add-button",onClick:E,disable:g.value.length==0},null,8,["disable"])]),_:1},8,["modelValue","label"])]),_:1})):G("",!0)]),_:1},8,["disable","label"])]))]),v.value?G("",!0):(i(),_("div",je,[l("div",Ge,[s(U,{icon:"files",class:"icon"}),l("div",Ke,m(e.$t("files")),1)]),l("div",Le,[l("div",Xe,[s(b,{label:e.$t("image"),"is-category":!0,type:"card",icon:"image",class:D({selected:C.value=="post_image"}),onClick:t[3]||(t[3]=a=>A("post_image"))},null,8,["label","class"]),s(b,{label:e.$t("video"),"is-category":!0,type:"card",icon:"video_file",class:D({selected:C.value=="post_video"}),onClick:t[4]||(t[4]=a=>A("post_video"))},null,8,["label","class"])]),l("div",{class:D(["drop-area card",{"drag-over":V.value,disabled:u.value.length>=S.value.maxCount}]),onDragover:t[5]||(t[5]=F(a=>V.value=!0,["prevent"])),onDragleave:t[6]||(t[6]=F(a=>V.value=!1,["prevent"])),onDrop:F(ne,["prevent"]),onClick:oe},[l("div",Ye,m(e.$t("drag_drop_title")),1),l("input",{type:"file",ref_key:"fileInput",ref:x,onChange:se,multiple:"",hidden:""},null,544)],34),(i(!0),_(M,null,R(u.value,(a,o)=>(i(),_("div",{class:D(["card file horizontal-container",{"is-error":!!a.error}]),key:o},[l("div",Ze,m(a.error&&e.$t("file_error.error",{error:e.$t(a.error)})||a.name),1),l("div",Je,"("+m(te(a.size))+")",1),s(b,{icon:"close",onClick:c=>ae(o),disable:u.value.length>=S.value.maxCount},null,8,["onClick","disable"])],2))),128))])])),s(L,{class:"separator"}),s(Ie,{"label-key":"tag.ai",icon:"robot_2",modelValue:P.value,"onUpdate:modelValue":t[7]||(t[7]=a=>P.value=a)},null,8,["modelValue"])]),_:1}),s(L,{class:"separator q-my-sm"}),l("div",We,[s(b,{type:"primary","icon-right":v.value?"edit":"add",label:v.value?e.$t("apply"):e.$t("create"),onClick:ie,disable:h.value.trim().length==0||u.value.some(a=>!!a.error),loading:p.value},null,8,["icon-right","label","disable","loading"])])])]),_:1})]),_:1},8,["onHide"]))}});export{ft as default};
