const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/OpenUserDialog-DnByXUN9.js","assets/index-l_6EiOmM.js","assets/index-CxWikQNB.css","assets/MyButton.vue_vue_type_script_setup_true_lang-DcG6jFCe.js"])))=>i.map(i=>d[i]);
import{j as U,D as q,a2 as x,u as H,h as m,V as D,E as p,F as M,X as O,k as E,o as L,w as T,m as r,q as j,l as z,s as F,t as J,H as N,n as Q,_ as X,bH as G,bI as R,bJ as _,aa as A}from"./index-l_6EiOmM.js";import{a as K,_ as W}from"./MyButton.vue_vue_type_script_setup_true_lang-DcG6jFCe.js";const Y={class:"image-container"},Z={class:"title"},ee={class:"message"},oe=U({__name:"NotificationCard",props:{notif:{},cache:{}},emits:["onLoaded"],setup(P,{emit:S}){const{t:c}=q(),g=x(),f=H(),V=J(()=>X(()=>import("./OpenUserDialog-DnByXUN9.js"),__vite__mapDeps([0,1,2,3])));let n=null;const v=m(()=>{var a;return e.notif.type=="new_comment"&&(a=e.notif.loaded)!=null&&a.parent_comment_id?"new_reply":e.notif.type}),e=P,y=S,s=D(e.cache),C={},I=p(null),d=p(!1),l=p(!1),$={new_comment:"chat_bubble",new_reply:"reply",followed:"person_add"};function b(a,t){s.value?s.value[e.notif.id][a]=t:C[a]=t}function h(a){return s.value?s.value[e.notif.id][a]:C[a]}const w=m(()=>{if(!e.notif.loaded)return{username:void 0,message:e.notif.message};if(e.notif.linked_type==="post"||e.notif.linked_type==="comment"){let a;return e.notif.loaded.content?a=e.notif.loaded.content:a=c("resource_not_found"),{username:e.notif.loaded.user.username,message:a}}return{username:void 0,message:void 0}}),B=m(()=>e.notif.loaded?(e.notif.linked_type==="post"||e.notif.linked_type==="comment")&&!e.notif.loaded.content:!1);async function u(a,t){try{d.value=!0;const o=h(t);if(o===void 0||o.lastSync+120>Date.now()*1e3){const i=await a();return b(t,{lastSync:Date.now()*1e3,data:i}),i}else return o.data}finally{d.value=!1}}async function k(){var a;if(!(l.value||d.value)){n||(n=new AbortController),e.notif.unread&&(G(e.notif.id),D(e.notif).value.unread=!1);try{if(e.notif.linked_type=="post"){const t=await u(()=>R(e.notif.loaded.post_id,{signal:n.signal}),"post");t.data.success&&f.openDialog("post",t.data.data.post_id,{post:t.data.data})}else if(e.notif.linked_type=="comment")if(e.notif.loaded.parent_comment_id){const[t,o]=await u(()=>Promise.all([_(e.notif.loaded.post_id,e.notif.loaded.parent_comment_id,{signal:n.signal}),_(e.notif.loaded.post_id,e.notif.loaded.comment_id,{signal:n.signal})]),"reply");o.data.success&&t.data.success&&(f.openDialog("replies",t.data.data.comment_id,{comment:t.data.data,inDialog:!1,firstComment:o.data.data,autoLoad:!1}),y("onLoaded"))}else{const[t,o]=await u(()=>Promise.all([R(e.notif.loaded.post_id,{signal:n.signal}),_(e.notif.loaded.post_id,e.notif.loaded.comment_id,{signal:n.signal})]),"post+comment");t.data.success&&o.data.success&&(f.openDialog("post",t.data.data.post_id,{post:t.data.data,firstComment:o.data.data,autoLoad:!1}),y("onLoaded"))}}catch(t){if(l.value=!0,b("disabled",!0),A(t)&&t.code=="ERR_CANCELED")return;if(A(t)&&((a=t.response)==null?void 0:a.status)==404)g.notify({type:"error-notification",message:c("resource_not_found")});else throw g.notify({type:"error-notification",message:c("an_error_occurred")}),t}}}return M(()=>{var a,t,o,i;s.value&&((o=(a=s.value)[t=e.notif.id])!=null||(a[t]={}),l.value=(i=h("disabled"))!=null?i:!1)}),O(()=>{n==null||n.abort()}),(a,t)=>(L(),E(W,{type:"card",class:Q(["notification",{unread:e.notif.unread}]),loading:d.value,disable:l.value||B.value,tabindex:"0",ref_key:"elementRef",ref:I,onClick:k},{default:T(()=>{var o;return[r("div",Y,[a.notif.linked_type=="post"||a.notif.linked_type=="comment"?(L(),E(F(V),{key:0,user:a.notif.loaded.user},null,8,["user"])):j("",!0),z(K,{icon:(o=$[v.value])!=null?o:"",class:"icon"},null,8,["icon"])]),r("div",{class:"text-container",onClick:k},[r("div",Z,N(a.$t(`notifications.${v.value}`,{username:w.value.username})),1),r("div",ee,N(w.value.message),1)])]}),_:1},8,["class","loading","disable"]))}});export{oe as _};
