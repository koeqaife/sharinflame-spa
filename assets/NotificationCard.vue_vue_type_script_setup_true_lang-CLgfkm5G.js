const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/OpenUserDialog-Durp-Dax.js","assets/index-atiAgRsb.js","assets/index-DI-gpe9-.css","assets/MyButton.vue_vue_type_script_setup_true_lang-Ce7HBHdZ.js"])))=>i.map(i=>d[i]);
import{j as T,D as $,a2 as U,u as q,h as m,V as L,E as p,F as x,X as F,k as E,o as _,w as O,m as g,q as N,l as j,s as R,t as z,p as J,H as Q,n as X,_ as G,bH as K,bI as S,bJ as v,aa as A}from"./index-atiAgRsb.js";import{a as W,_ as Y}from"./MyButton.vue_vue_type_script_setup_true_lang-Ce7HBHdZ.js";import{a as Z}from"./format-CbTbOXc7.js";const ee={class:"image-container"},te={class:"title"},ae=["innerHTML"],ie=T({__name:"NotificationCard",props:{notif:{},cache:{}},emits:["onLoaded"],setup(H,{emit:P}){const{t:r}=$(),y=U(),c=q(),V=z(()=>G(()=>import("./OpenUserDialog-Durp-Dax.js"),__vite__mapDeps([0,1,2,3])));let n=null;const C=m(()=>{var a;return e.notif.type=="new_comment"&&(a=e.notif.loaded)!=null&&a.parent_comment_id?"new_reply":e.notif.type}),e=H,b=P,s=L(e.cache),h={},B=p(null),l=p(!1),d=p(!1),I={new_comment:"chat_bubble",new_reply:"reply",followed:"person_add"};function k(a,t){s.value?s.value[e.notif.id][a]=t:h[a]=t}function w(a){return s.value?s.value[e.notif.id][a]:h[a]}const f=m(()=>{if(!e.notif.loaded)return{username:void 0,message:e.notif.message};if(e.notif.linked_type==="post"||e.notif.linked_type==="comment"){let a;return e.notif.loaded.content?a=e.notif.loaded.content:a=r("resource_not_found"),{username:e.notif.loaded.user.username,message:a}}return{username:void 0,message:void 0}}),M=m(()=>e.notif.loaded?(e.notif.linked_type==="post"||e.notif.linked_type==="comment")&&!e.notif.loaded.content:!1);async function u(a,t){try{l.value=!0;const o=w(t);if(o===void 0||o.lastSync+120>Date.now()*1e3){const i=await a();return k(t,{lastSync:Date.now()*1e3,data:i}),i}else return o.data}finally{l.value=!1}}async function D(){var a;if(!(d.value||l.value)){n||(n=new AbortController),e.notif.unread&&(K(e.notif.id),L(e.notif).value.unread=!1);try{if(e.notif.linked_type=="post"){const t=await u(()=>S(e.notif.loaded.post_id,{signal:n.signal}),"post");t.data.success&&c.openDialog("post",t.data.data.post_id,{post:t.data.data})}else if(e.notif.linked_type=="comment")if(e.notif.loaded.parent_comment_id){const[t,o]=await u(()=>Promise.all([v(e.notif.loaded.post_id,e.notif.loaded.parent_comment_id,{signal:n.signal}),v(e.notif.loaded.post_id,e.notif.loaded.comment_id,{signal:n.signal})]),"reply");o.data.success&&t.data.success&&(c.openDialog("replies",t.data.data.comment_id,{comment:t.data.data,inDialog:!1,firstComment:o.data.data,autoLoad:!1}),b("onLoaded"))}else{const[t,o]=await u(()=>Promise.all([S(e.notif.loaded.post_id,{signal:n.signal}),v(e.notif.loaded.post_id,e.notif.loaded.comment_id,{signal:n.signal})]),"post+comment");t.data.success&&o.data.success&&(c.openDialog("post",t.data.data.post_id,{post:t.data.data,firstComment:o.data.data,autoLoad:!1}),b("onLoaded"))}}catch(t){if(d.value=!0,k("disabled",!0),A(t)&&t.code=="ERR_CANCELED")return;if(A(t)&&((a=t.response)==null?void 0:a.status)==404)y.notify({type:"error-notification",message:r("resource_not_found")});else throw y.notify({type:"error-notification",message:r("an_error_occurred")}),t}}}return x(()=>{var a,t,o,i;s.value&&((o=(a=s.value)[t=e.notif.id])!=null||(a[t]={}),d.value=(i=w("disabled"))!=null?i:!1)}),F(()=>{n==null||n.abort()}),(a,t)=>(_(),E(Y,{type:"card",class:X(["notification",{unread:e.notif.unread}]),loading:l.value,disable:d.value||M.value,tabindex:"0",ref_key:"elementRef",ref:B,onClick:D},{default:O(()=>{var o;return[g("div",ee,[a.notif.linked_type=="post"||a.notif.linked_type=="comment"?(_(),E(R(V),{key:0,user:a.notif.loaded.user},null,8,["user"])):N("",!0),j(W,{icon:(o=I[C.value])!=null?o:"",class:"icon"},null,8,["icon"])]),g("div",{class:"text-container",onClick:D},[g("div",te,Q(a.$t(`notifications.${C.value}`,{username:f.value.username})),1),f.value.message?(_(),J("div",{key:0,class:"message",innerHTML:R(Z)(f.value.message)},null,8,ae)):N("",!0)])]}),_:1},8,["class","loading","disable"]))}});export{ie as _};
